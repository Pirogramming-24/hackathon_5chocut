{% extends 'piro_index/base.html' %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/video_detail.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
{{ graph_data_json|json_script:"graph-data" }}

<div class="page-container" 
     data-video-id="{{ video.pk }}"
     data-comment-create-url="{% url 'piro_index:video_comment_create_ajax' video.pk %}">

    {% if is_staff %}
    <div class="admin-controls">
        <a href="{% url 'piro_index:video_update' video.pk %}">
            <button type="button">ì˜ìƒ ìˆ˜ì •</button>
        </a>
        <form action="{% url 'piro_index:video_delete' video.pk %}" method="POST" 
            onsubmit="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" style="display:inline;">
            {% csrf_token %}
            <button type="submit">ì˜ìƒ ì‚­ì œ</button>
        </form>
    </div>
    {% endif %}

    <div class="top-section">
        <div class="video-area">
            <video id="lecture" controls poster="{% static 'images/video_error.png' %}" style="width:100%;">
                <source src="{{ video.video_path.url }}" type="video/mp4">
            </video>
            <h3>{{ video.title }}</h3>
        </div>

        <div class="timeline-area">
            <h3>ğŸ“Œ ì£¼ìš” ê°œë… íƒ€ì„ë¼ì¸</h3>
            <div class="timeline-list">
                {% for timeline in timelines %}
                <div class="timeline-item" onclick="seekTo({{ timeline.timetag }}, this)">
                    <span class="time-badge">{{ timeline.time_str }}</span>
                    <span class="content-text">{{ timeline.content }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="comment-section">
            <div class="comment-input-box">
                <div class="input-header">
                    <input type="number" id="comment-timetag" placeholder="0" value="0">
                    <span class="sec-label">ì´ˆ</span>
                    <input type="file" id="comment-image" accept="image/*">
                </div>
                <textarea id="comment-content" placeholder="ì§ˆë¬¸ì„ ë‚¨ê²¨ë³´ì„¸ìš”!"></textarea>
                <button id="comment-submit-btn">ë“±ë¡</button>
            </div>

            <div id="comment-list-container">
                {% for comment in comments %}
                <div class="comment-card" id="comment-{{ comment.pk }}">
                    <div class="card-header">
                        <span class="timetag-badge" onclick="seekTo({{ comment.timetag }})">
                            {{ comment.time_str }}
                        </span>
                        <span class="username">{{ comment.user.name }}</span>
                    </div>

                    <div class="card-body">
                        <p>{{ comment.content }}</p>
                        {% if comment.image %}
                        <img src="{{ comment.image.url }}" style="max-width: 200px; margin-top:10px;">
                        {% endif %}
                    </div>

                    <div class="card-footer">
                        <button class="like-btn" 
                                data-comment-id="{{ comment.pk }}"
                                data-url="{% url 'piro_index:comment_like_ajax' comment.pk %}">
                            ğŸ”¥ ê¶ê¸ˆí•´ìš” <span class="like-count">{{ comment.like_count }}</span>
                        </button>

                        <button class="reply-toggle-btn" data-comment-id="{{ comment.pk }}">
                            ë‹µê¸€ {{ comment.replies_list|length }}
                        </button>
                        
                        {% if user.role == 'ìš´ì˜ì§„' %}
                        <button class="btn-delete-comment" 
                                data-comment-id="{{ comment.pk }}"
                                data-url="{% url 'piro_index:video_comment_delete' comment.pk %}">
                            ì‚­ì œ
                        </button>
                        {% endif %}
                    </div>
                    
                    <div class="reply-area" data-reply-id="{{ comment.pk }}" style="display:none;">
                        {% for reply in comment.replies_list %}
                        <div class="reply-item">
                            <strong>{{ reply.user.name }}</strong>: {{ reply.content }}
                        </div>
                        {% endfor %}
                        
                        <div class="reply-input-row">
                            <input type="text" data-reply-input-id="{{ comment.pk }}" placeholder="ë‹µê¸€ ì‘ì„±">
                            <button class="reply-submit-btn" 
                                    data-comment-id="{{ comment.pk }}"
                                    data-url="{% url 'piro_index:comment_reply_create_ajax' comment.pk %}">
                                ë“±ë¡
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="graph-section">
            <h3>ğŸ”¥ ì§ˆë¬¸ ê³µê°ë„ ê·¸ë˜í”„</h3>
            <div style="height: 300px;">
                <canvas id="questionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/video_detail.js' %}"></script>
{% endblock %}