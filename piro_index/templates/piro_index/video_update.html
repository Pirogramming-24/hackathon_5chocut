{% extends 'piro_index/base.html' %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/video_update.css' %}">
{% endblock %}

{% block content %}
<div class="upload-wrap">
  <div class="upload-card">
    <div class="upload-card-top">
      <h1 class="upload-title">Video Update</h1>
    </div>

    <form class="upload-form" method="POST" enctype="multipart/form-data" action="{% url 'piro_index:video_update' pk=video.pk %}">
      {% csrf_token %}
      
      <div class="top-row">
        <!-- ì™¼ìª½: ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° (ê¸°ì¡´ ë¹„ë””ì˜¤ í‘œì‹œ) -->
        <div class="preview-box">
          <video class="preview-video" id="videoPreview" controls style="display: block;">
            <source src="{{ video.video_path.url }}" type="video/mp4">
          </video>
          <div class="preview-placeholder" id="previewPlaceholder" style="display: none;">
            <span class="preview-icon">ğŸ“¹</span>
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="file-col">
          <!-- ì˜ìƒ ë“±ë¡ -->
          <div class="file-box">
            <div class="file-box-title">ì˜ìƒ ë“±ë¡</div>
            <label for="videoFile" class="file-btn">íŒŒì¼ ë³€ê²½</label>
            <input type="file" id="videoFile" name="video_path" class="file-input" accept="video/*">
            <div class="file-name" id="videoFileName">{{ video.video_path.name|default:"í˜„ì¬ íŒŒì¼" }}</div>
            <div class="file-note">íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ íŒŒì¼ ìœ ì§€</div>
          </div>

          <!-- ì¸ë„¤ì¼ ë“±ë¡ -->
          <div class="file-box">
            <div class="file-box-title">ì¸ë„¤ì¼ ë“±ë¡</div>
            <label for="thumbnailFile" class="file-btn">íŒŒì¼ ë³€ê²½</label>
            <input type="file" id="thumbnailFile" name="thumbnail" class="file-input" accept="image/*">
            <div class="file-name" id="thumbnailFileName">
              {% if video.thumbnail %}
                {{ video.thumbnail.name }}
              {% else %}
                ë“±ë¡ëœ ì¸ë„¤ì¼ ì—†ìŒ
              {% endif %}
            </div>
            <div class="file-note">íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ íŒŒì¼ ìœ ì§€</div>
          </div>
        </div>
      </div>

      <!-- ì œëª© ì…ë ¥ (ê¸°ì¡´ ì œëª©ìœ¼ë¡œ prefill) -->
      <div class="field">
        <label class="field-label" for="videoTitle">ì„¸ì…˜ ì œëª©</label>
        <input type="text" class="field-input" id="videoTitle" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ video.title }}" required>
      </div>

      <!-- íƒ€ì„ë¼ì¸ íƒœê·¸ -->
      <div class="field">
        <label class="field-label">íƒ€ì„ë¼ì¸ íƒœê·¸</label>
        <div class="timeline-bar">
          <div class="bookmark">
            <img src="{% static 'images/Video_Tag.png' %}" alt="ë¶ë§ˆí¬" class="bookmark-icon">
          </div>
          <input type="text" class="time-input" id="timeInput" placeholder="00:00:00">
          <input type="text" class="tag-input" id="tagInput" placeholder="íƒœê·¸ ë‚´ìš©">
          <button type="button" class="add-btn" id="addTagBtn">ì¶”ê°€</button>
        </div>
        
        <!-- ì¶”ê°€ëœ íƒœê·¸ ë¦¬ìŠ¤íŠ¸ -->
        <div class="tag-list" id="tagList"></div>
        
        <!-- hidden inputìœ¼ë¡œ íƒ€ì„ë¼ì¸ ë°ì´í„° ì „ì†¡ -->
        <input type="hidden" name="timeline_data" id="timelineData">
      </div>

      <!-- ë²„íŠ¼ ê·¸ë£¹ -->
      <div class="button-group">
        <a href="{% url 'piro_index:video_detail' pk=video.pk %}" class="cancel-btn">ì·¨ì†Œ</a>
        <button type="submit" class="submit-btn">ìˆ˜ì • ì™„ë£Œ</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ê¸°ì¡´ íƒ€ì„ë¼ì¸ ë°ì´í„°ë¥¼ JavaScript ë°°ì—´ë¡œ ë¡œë“œ
  let timelineArray = {{ timeline_json|safe }};

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ íƒ€ì„ë¼ì¸ ì¹©ë“¤ í‘œì‹œ
  window.addEventListener('DOMContentLoaded', function() {
    // ê¸°ì¡´ íƒ€ì„ë¼ì¸ ì¹© ì¶”ê°€
    timelineArray.forEach(item => {
      addTagChip(item.timeStr, item.tag);
    });
    
    // hidden input ì´ˆê¸°í™”
    document.getElementById('timelineData').value = JSON.stringify(timelineArray);
  });

  // ë¹„ë””ì˜¤ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
  document.getElementById('videoFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('videoFileName').textContent = file.name;
      
      const videoURL = URL.createObjectURL(file);
      const videoPreview = document.getElementById('videoPreview');
      videoPreview.src = videoURL;
      videoPreview.style.display = 'block';
      document.getElementById('previewPlaceholder').style.display = 'none';
    }
  });

  // ì¸ë„¤ì¼ íŒŒì¼ ì„ íƒ ì‹œ
  document.getElementById('thumbnailFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('thumbnailFileName').textContent = file.name;
    }
  });

  // íƒ€ì„ë¼ì¸ íƒœê·¸ ì¶”ê°€
  document.getElementById('addTagBtn').addEventListener('click', function() {
    const timeInput = document.getElementById('timeInput').value;
    const tagInput = document.getElementById('tagInput').value;
    
    if (!timeInput || !tagInput) {
      alert('ì‹œê°„ê³¼ íƒœê·¸ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì‹œê°„ì„ ì´ˆë¡œ ë³€í™˜
    const timeInSeconds = convertTimeToSeconds(timeInput);
    
    // ë°°ì—´ì— ì¶”ê°€
    timelineArray.push({
      time: timeInSeconds,
      tag: tagInput,
      timeStr: timeInput
    });

    // í™”ë©´ì— ì¹© ì¶”ê°€
    addTagChip(timeInput, tagInput);

    // hidden input ì—…ë°ì´íŠ¸
    document.getElementById('timelineData').value = JSON.stringify(timelineArray);

    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('timeInput').value = '';
    document.getElementById('tagInput').value = '';
  });

  // ì‹œê°„ ë¬¸ìì—´ì„ ì´ˆë¡œ ë³€í™˜ (HH:MM:SS -> seconds)
  function convertTimeToSeconds(timeStr) {
    const parts = timeStr.split(':');
    if (parts.length === 3) {
      return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
    } else if (parts.length === 2) {
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    }
    return parseInt(timeStr);
  }

  // íƒœê·¸ ì¹© ì¶”ê°€
  function addTagChip(time, tag) {
    const tagList = document.getElementById('tagList');
    const chip = document.createElement('div');
    chip.className = 'tag-chip';
    chip.innerHTML = `
      <span class="tag-chip-time">${time}</span>
      <span class="tag-chip-text">${tag}</span>
      <button type="button" class="tag-chip-x" onclick="removeTag(this, '${time}', '${tag}')">Ã—</button>
    `;
    tagList.appendChild(chip);
  }

  // íƒœê·¸ ì œê±°
  function removeTag(btn, time, tag) {
    // ë°°ì—´ì—ì„œ ì œê±°
    timelineArray = timelineArray.filter(item => 
      !(item.timeStr === time && item.tag === tag)
    );
    
    // hidden input ì—…ë°ì´íŠ¸
    document.getElementById('timelineData').value = JSON.stringify(timelineArray);
    
    // í™”ë©´ì—ì„œ ì œê±°
    btn.parentElement.remove();
  }
</script>
{% endblock %}