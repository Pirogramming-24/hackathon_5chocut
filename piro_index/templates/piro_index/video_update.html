{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/video_upload.css' %}">
{% endblock %}

{% block content %}
<div class="upload-wrap">
  <div class="upload-card">
    <div class="upload-card-top">
      <h1 class="upload-title">Video Update</h1>
    </div>

    <form class="upload-form"
          method="post"
          enctype="multipart/form-data"
          action="{% url 'piro_index:video_update' video.pk %}">
      {% csrf_token %}

      <div class="top-row">
        <!-- ì™¼ìª½: ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="preview-box">
          <video class="preview-video" id="videoPreview" controls></video>
          <div class="preview-placeholder" id="previewPlaceholder">
            <span class="preview-icon">ğŸ“¹</span>
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="file-col">
          <!-- ì˜ìƒ êµì²´ -->
          <div class="file-box">
            <div class="file-box-title">ì˜ìƒ êµì²´</div>
            <label for="videoFile" class="file-btn">íŒŒì¼ ì°¾ê¸°</label>
            <input type="file" id="videoFile" name="video_path" class="file-input" accept="video/*">
            <div class="file-name" id="videoFileName">
              {% if video.video_path %}í˜„ì¬ íŒŒì¼: {{ video.video_path.name }}{% else %}ì„ íƒëœ íŒŒì¼ ì—†ìŒ{% endif %}
            </div>
          </div>

          <!-- ì¸ë„¤ì¼ êµì²´ -->
          <div class="file-box">
            <div class="file-box-title">ì¸ë„¤ì¼ êµì²´</div>
            <label for="thumbnailFile" class="file-btn">íŒŒì¼ ì°¾ê¸°</label>
            <input type="file" id="thumbnailFile" name="thumbnail" class="file-input" accept="image/*">
            <div class="file-name" id="thumbnailFileName">
              {% if video.thumbnail %}í˜„ì¬ íŒŒì¼: {{ video.thumbnail.name }}{% else %}ì„ íƒëœ íŒŒì¼ ì—†ìŒ{% endif %}
            </div>

            {% if video.thumbnail %}
              <div style="margin-top:10px;">
                <img src="{{ video.thumbnail.url }}" alt="thumbnail" style="width:100%; border-radius:12px;">
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- ì œëª© ì…ë ¥ (í”„ë¦¬í•„) -->
      <div class="field">
        <label class="field-label" for="videoTitle">ì„¸ì…˜ ì œëª©</label>
        <input type="text" class="field-input" id="videoTitle" name="title"
               value="{{ video.title }}" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
      </div>

      <!-- íƒ€ì„ë¼ì¸ íƒœê·¸ -->
      <div class="field">
        <label class="field-label">íƒ€ì„ë¼ì¸ íƒœê·¸</label>
        <div class="timeline-bar">
          <div class="bookmark">
            <img src="{% static 'images/Video_Tag.png' %}" alt="ë¶ë§ˆí¬" class="bookmark-icon">
          </div>
          <input type="text" class="time-input" id="timeInput" placeholder="00:00:00">
          <input type="text" class="tag-input" id="tagInput" placeholder="íƒœê·¸ ë‚´ìš©">
          <button type="button" class="add-btn" id="addTagBtn">ì¶”ê°€</button>
        </div>

        <div class="tag-list" id="tagList"></div>

        <!-- í”„ë¦¬í•„ JSONì„ ê·¸ëŒ€ë¡œ hiddenì— ë„£ì–´ë‘  -->
        <input type="hidden" name="timeline_data" id="timelineData" value="{{ timeline_json|escapejs }}">
      </div>

      <button type="submit" class="submit-btn">ìˆ˜ì • ì™„ë£Œ</button>
    </form>
  </div>
</div>

<script>
  // hiddenì— ë“¤ì–´ìˆëŠ” í”„ë¦¬í•„ JSON ë¡œë“œ
  let timelineArray = [];
  const hiddenEl = document.getElementById('timelineData');
  try {
    const raw = hiddenEl.value || '[]';
    timelineArray = JSON.parse(raw);
  } catch (e) {
    timelineArray = [];
    hiddenEl.value = '[]';
  }

  // DB í”„ë¦¬í•„ íƒœê·¸ ì¹© ë Œë”
  function addTagChip(timeStr, tag, seconds) {
    const tagList = document.getElementById('tagList');
    const chip = document.createElement('div');
    chip.className = 'tag-chip';
    chip.dataset.time = String(seconds);
    chip.dataset.tag = tag;

    chip.innerHTML = `
      <span class="tag-chip-time">${timeStr}</span>
      <span class="tag-chip-text">${tag}</span>
      <button type="button" class="tag-chip-x">Ã—</button>
    `;

    chip.querySelector('.tag-chip-x').addEventListener('click', () => {
      removeTag(seconds, tag, chip);
    });

    tagList.appendChild(chip);
  }

  function syncHidden() {
    hiddenEl.value = JSON.stringify(timelineArray);
  }

  function renderAllChips() {
    document.getElementById('tagList').innerHTML = '';
    timelineArray.forEach(item => {
      const seconds = item.time;
      const timeStr = item.timeStr || formatSeconds(seconds);
      addTagChip(timeStr, item.tag, seconds);
    });
    syncHidden();
  }

  // ê¸°ì¡´ ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° (MEDIA ì„¸íŒ… ë˜ì–´ìˆë‹¤ëŠ” ì „ì œ)
  (function initVideoPreview() {
    const videoPreview = document.getElementById('videoPreview');
    const placeholder = document.getElementById('previewPlaceholder');

    { % if video.video_path % }
      videoPreview.src = "{{ video.video_path.url }}";
      videoPreview.style.display = 'block';
      placeholder.style.display = 'none';
    { % endif % }
  })();

  // ë¹„ë””ì˜¤ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°(êµì²´)
  document.getElementById('videoFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('videoFileName').textContent = file.name;

      const videoURL = URL.createObjectURL(file);
      const videoPreview = document.getElementById('videoPreview');
      videoPreview.src = videoURL;
      videoPreview.style.display = 'block';
      document.getElementById('previewPlaceholder').style.display = 'none';
    }
  });

  // ì¸ë„¤ì¼ íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ëª…ë§Œ ë³€ê²½
  document.getElementById('thumbnailFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('thumbnailFileName').textContent = file.name;
    }
  });

  // íƒ€ì„ë¼ì¸ íƒœê·¸ ì¶”ê°€
  document.getElementById('addTagBtn').addEventListener('click', function() {
    const timeInput = document.getElementById('timeInput').value.trim();
    const tagInput = document.getElementById('tagInput').value.trim();

    if (!timeInput || !tagInput) {
      alert('ì‹œê°„ê³¼ íƒœê·¸ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const timeInSeconds = convertTimeToSeconds(timeInput);
    if (timeInSeconds === null) {
      alert('ì‹œê°„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆ: 12:30 ë˜ëŠ” 01:25:30');
      return;
    }

    timelineArray.push({
      time: timeInSeconds,
      tag: tagInput,
      timeStr: normalizeTimeStr(timeInput, timeInSeconds)
    });

    renderAllChips();

    document.getElementById('timeInput').value = '';
    document.getElementById('tagInput').value = '';
  });

  function removeTag(seconds, tag, chipEl) {
    timelineArray = timelineArray.filter(item => !(item.time === seconds && item.tag === tag));
    syncHidden();
    chipEl.remove();
  }

  function convertTimeToSeconds(timeStr) {
    const parts = timeStr.split(':').map(p => p.trim());
    if (parts.length === 3) {
      const h = parseInt(parts[0], 10), m = parseInt(parts[1], 10), s = parseInt(parts[2], 10);
      if ([h,m,s].some(n => Number.isNaN(n))) return null;
      return h * 3600 + m * 60 + s;
    } else if (parts.length === 2) {
      const m = parseInt(parts[0], 10), s = parseInt(parts[1], 10);
      if ([m,s].some(n => Number.isNaN(n))) return null;
      return m * 60 + s;
    } else if (parts.length === 1) {
      const sec = parseInt(parts[0], 10);
      if (Number.isNaN(sec)) return null;
      return sec;
    }
    return null;
  }

  function formatSeconds(seconds) {
    seconds = parseInt(seconds || 0, 10);
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
  }

  function normalizeTimeStr(raw, seconds) {
    // ì‚¬ìš©ìê°€ 12:30 ë„£ì–´ë„ ì €ì¥/í‘œì‹œëŠ” í†µì¼ëœ í¬ë§·ì´ ê¹”ë”í•¨
    return formatSeconds(seconds);
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ DB íƒ€ì„ë¼ì¸ í”„ë¦¬í•„ ë Œë”
  renderAllChips();
</script>
{% endblock %}
